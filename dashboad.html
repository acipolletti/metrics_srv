<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Metriche Real-time</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #0f0f0f;
            color: #e0e0e0;
            padding: 20px;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        h1 {
            color: #00ff41;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-align: center;
            text-shadow: 0 0 10px rgba(0, 255, 65, 0.5);
        }
        
        .controls {
            background: #1a1a1a;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            border: 1px solid #333;
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .controls input, .controls button, .controls select {
            padding: 10px 15px;
            background: #2a2a2a;
            border: 1px solid #444;
            color: #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .controls button {
            cursor: pointer;
            background: #00ff41;
            color: #000;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .controls button:hover {
            background: #00cc33;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 65, 0.3);
        }
        
        .controls button:disabled {
            background: #666;
            cursor: not-allowed;
            transform: none;
        }
        
        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
            margin-left: auto;
        }
        
        .status.connected {
            background: #00ff41;
            color: #000;
        }
        
        .status.disconnected {
            background: #ff0041;
            color: #fff;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .metric-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            position: relative;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .metric-card:hover {
            border-color: #00ff41;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0, 255, 65, 0.2);
        }
        
        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff41, transparent);
            animation: scan 2s linear infinite;
        }
        
        @keyframes scan {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .metric-name {
            font-size: 1.2em;
            font-weight: bold;
            color: #00ff41;
            margin-bottom: 10px;
        }
        
        .metric-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 10px;
            font-family: 'Courier New', monospace;
        }
        
        .metric-tags {
            font-size: 0.8em;
            color: #888;
            margin-bottom: 5px;
        }
        
        .metric-time {
            font-size: 0.7em;
            color: #666;
            position: absolute;
            bottom: 10px;
            right: 10px;
        }
        
        .log-container {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .log-entry {
            font-family: 'Courier New', monospace;
            font-size: 12px;
            padding: 5px;
            border-bottom: 1px solid #222;
            white-space: pre-wrap;
            word-break: break-all;
        }
        
        .log-entry:hover {
            background: #222;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .chart-card {
            background: #1a1a1a;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 20px;
        }
        
        canvas {
            max-width: 100%;
            height: 200px !important;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìä Dashboard Metriche Real-time</h1>
        
        <div class="controls">
            <input type="text" id="serverUrl" placeholder="Server URL" value="https://localhost:8443">
            <input type="password" id="apiKey" placeholder="API Key">
            <input type="text" id="metricsFilter" placeholder="Metriche (comma-separated)">
            <select id="hostFilter">
                <option value="">Tutti gli host</option>
            </select>
            <button id="connectBtn" onclick="toggleConnection()">Connetti</button>
            <span id="status" class="status disconnected">Disconnesso</span>
        </div>
        
        <div class="metrics-grid" id="metricsGrid"></div>
        
        <div class="charts-container">
            <div class="chart-card">
                <h3>CPU Usage Trend</h3>
                <canvas id="cpuChart"></canvas>
            </div>
            <div class="chart-card">
                <h3>Memory Usage Trend</h3>
                <canvas id="memoryChart"></canvas>
            </div>
        </div>
        
        <h3 style="margin: 20px 0 10px">üìù Log Eventi</h3>
        <div class="log-container" id="logContainer"></div>
    </div>

    <script>
        let eventSource = null;
        let metrics = new Map();
        let charts = {};
        let maxDataPoints = 50;
        
        // Inizializza grafici
        function initCharts() {
            const chartConfig = {
                type: 'line',
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: {
                        duration: 0
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: {
                                unit: 'second'
                            },
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                color: '#888'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: '#333'
                            },
                            ticks: {
                                color: '#888'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#888'
                            }
                        }
                    }
                }
            };
            
            // CPU Chart
            charts.cpu = new Chart(document.getElementById('cpuChart'), {
                ...chartConfig,
                data: {
                    datasets: []
                }
            });
            
            // Memory Chart
            charts.memory = new Chart(document.getElementById('memoryChart'), {
                ...chartConfig,
                data: {
                    datasets: []
                }
            });
        }
        
        function addLog(message) {
            const logContainer = document.getElementById('logContainer');
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.insertBefore(entry, logContainer.firstChild);
            
            // Mantieni solo gli ultimi 100 log
            while (logContainer.children.length > 100) {
                logContainer.removeChild(logContainer.lastChild);
            }
        }
        
        function updateMetricCard(metric) {
            const key = `${metric.name}-${JSON.stringify(metric.tags)}`;
            let card = document.getElementById(`metric-${key}`);
            
            if (!card) {
                card = document.createElement('div');
                card.id = `metric-${key}`;
                card.className = 'metric-card';
                document.getElementById('metricsGrid').appendChild(card);
            }
            
            const mainField = Object.keys(metric.fields)[0];
            const mainValue = metric.fields[mainField];
            
            card.innerHTML = `
                <div class="metric-name">${metric.name}</div>
                <div class="metric-value">${mainValue.toFixed(2)}</div>
                <div class="metric-tags">${Object.entries(metric.tags).map(([k,v]) => `${k}: ${v}`).join(', ')}</div>
                <div class="metric-time">${new Date(metric.timestamp).toLocaleTimeString()}</div>
            `;
            
            // Animazione flash
            card.style.borderColor = '#00ff41';
            setTimeout(() => {
                card.style.borderColor = '#333';
            }, 300);
        }
        
        function updateChart(chartName, metric) {
            const chart = charts[chartName];
            if (!chart) return;
            
            const host = metric.tags.host || 'unknown';
            let dataset = chart.data.datasets.find(d => d.label === host);
            
            if (!dataset) {
                dataset = {
                    label: host,
                    data: [],
                    borderColor: `hsl(${chart.data.datasets.length * 60}, 70%, 50%)`,
                    backgroundColor: 'transparent',
                    borderWidth: 2,
                    tension: 0.1
                };
                chart.data.datasets.push(dataset);
            }
            
            // Aggiungi punto dati
            const field = chartName === 'cpu' ? 'usage' : 'used';
            if (metric.fields[field] !== undefined) {
                dataset.data.push({
                    x: metric.timestamp,
                    y: metric.fields[field]
                });
                
                // Rimuovi vecchi punti
                if (dataset.data.length > maxDataPoints) {
                    dataset.data.shift();
                }
                
                chart.update('none');
            }
        }
        
        function connectToStream() {
            const serverUrl = document.getElementById('serverUrl').value;
            const apiKey = document.getElementById('apiKey').value;
            const metricsFilter = document.getElementById('metricsFilter').value;
            const hostFilter = document.getElementById('hostFilter').value;
            
            let url = `${serverUrl}/stream`;
            const params = new URLSearchParams();
            
            if (metricsFilter) {
                params.append('metrics', metricsFilter);
            }
            if (hostFilter) {
                params.append('tag.host', hostFilter);
            }
            
            if (params.toString()) {
                url += '?' + params.toString();
            }
            
            const headers = {};
            if (apiKey) {
                headers['Authorization'] = `Bearer ${apiKey}`;
            }
            
            eventSource = new EventSource(url, {
                headers: headers,
                withCredentials: false
            });
            
            eventSource.addEventListener('metric', (event) => {
                try {
                    const metric = JSON.parse(event.data);
                    updateMetricCard(metric);
                    
                    // Aggiorna grafici
                    if (metric.name === 'cpu' || metric.name === 'system') {
                        updateChart('cpu', metric);
                    }
                    if (metric.name === 'memory' || metric.name === 'system') {
                        updateChart('memory', metric);
                    }
                    
                    // Aggiorna lista host
                    if (metric.tags.host && !document.querySelector(`#hostFilter option[value="${metric.tags.host}"]`)) {
                        const option = document.createElement('option');
                        option.value = metric.tags.host;
                        option.textContent = metric.tags.host;
                        document.getElementById('hostFilter').appendChild(option);
                    }
                    
                    addLog(`Ricevuta metrica: ${metric.name} da ${metric.tags.host || 'unknown'}`);
                } catch (e) {
                    addLog(`Errore parsing metrica: ${e.message}`);
                }
            });
            
            eventSource.onopen = () => {
                document.getElementById('status').className = 'status connected';
                document.getElementById('status').textContent = 'Connesso';
                document.getElementById('connectBtn').textContent = 'Disconnetti';
                addLog('Connesso al server');
            };
            
            eventSource.onerror = (error) => {
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = 'Errore connessione';
                addLog(`Errore connessione: ${error.message || 'Connessione persa'}`);
            };
        }
        
        function disconnect() {
            if (eventSource) {
                eventSource.close();
                eventSource = null;
                document.getElementById('status').className = 'status disconnected';
                document.getElementById('status').textContent = 'Disconnesso';
                document.getElementById('connectBtn').textContent = 'Connetti';
                addLog('Disconnesso dal server');
            }
        }
        
        function toggleConnection() {
            if (eventSource && eventSource.readyState !== EventSource.CLOSED) {
                disconnect();
            } else {
                connectToStream();
            }
        }
        
        // Inizializzazione
        window.onload = () => {
            initCharts();
            addLog('Dashboard caricata - Premi Connetti per iniziare');
        };
        
        // Cleanup alla chiusura
        window.onbeforeunload = () => {
            disconnect();
        };
    </script>
</body>
</html>